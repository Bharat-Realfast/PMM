minimum_cumulusci_version: '2.5.9'
project:
    name: pmdm
    package:
        name:  Program Management Data Model
        namespace: pmdm0
        api_version: '46.0'
    source_format: sfdx

orgs:
    scratch:
        dev_namespaced:
            config_file: orgs/dev.json
            days: 7
            namespaced: True
        prerelease:
            config_file: orgs/prerelease.json
            days: 7
        npsp:
            config_file: orgs/npsp.json
            days: 7
        npsp_namespaced:
            config_file: orgs/npsp.json
            days: 7
            namespaced: True

tasks:
    robot:
        options:
            suites: robot/pmdm/tests
            options:
                outputdir: robot/pmdm/results

    robot_testdoc:
        options:
            path: robot/pmdm/tests
            output: robot/pmdm/doc/pmdm_tests.html

    run_all_local_tests:
        group: 'Tests'
        description: 'Runs all local Apex Tests including code coverage'
        class_path: cumulusci.tasks.sfdx.SFDXOrgTask
        options:
            command: 'force:apex:test:run --codecoverage --testlevel RunLocalTests --resultformat human'

    dx:
        group: 'Salesforce DX'
        description: 'Calls a sfdx task with the cci Org User specificed.  Enter the sfdx task with the command option'
        class_path: cumulusci.tasks.sfdx.SFDXOrgTask

    dx_status:
        group: 'Salesforce DX'
        description: 'Calls sfdx force:source:status for cci Org User'
        class_path: cumulusci.tasks.sfdx.SFDXOrgTask
        options:
            command: 'force:source:status'

    insert_bulk_data:
        group: "Data: Bulk"
        description: "Inserts bulk data at sql_path into org.  Implmementations need to specify mappings beyond base mapping."
        class_path: tasks.BulkData.InsertData
        options:
            ignore_row_errors: True
            sql_path: data/bulk/data.sql
            pre_mappings: 
                - path: data/bulk/mapping/Household_Accounts.yml
                - path: data/bulk/mapping/Organization_Accounts.yml
                - path: data/bulk/mapping/Contacts.yml
            package_mapping_directories: 
                - data/bulk/mapping/packages
            log_mapping: True

    log_bulk_data_mapping:
        group: "Data: Bulk"
        description: "Logs generated mapping"
        class_path: tasks.BulkData.LogMapping
        options:
            pre_mappings: 
                - path: data/bulk/mapping/Household_Accounts.yml
                - path: data/bulk/mapping/Organization_Accounts.yml
                - path: data/bulk/mapping/Contacts.yml
            package_mapping_directories: 
                - data/bulk/mapping/packages
            log_mapping: True

flows:
    
    config_unmanaged:
        steps:
            200:
                task: insert_bulk_data
            301:
                task: execute_anon
                options:
                    path: "data/scripts/update_all_records_as_recently_viewed.apex"

    config_unmanaged_namespaced:
        steps:
            200:
                task: insert_bulk_data
            301:
                task: execute_anon
                options:
                    path: "data/scripts/update_all_records_as_recently_viewed.apex"

    config_qa:
        100:
            task: deploy_qa_config
        200:
            flow: config_unmanaged

    config_dev:
        steps:
            200:
                flow: config_unmanaged

