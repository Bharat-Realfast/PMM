minimum_cumulusci_version: '2.5.9'
project:
    name: pmdm
    package:
        name:  Program Management Data Model
        namespace: pmdm0
        api_version: '46.0'
    source_format: sfdx

orgs:
    scratch:
        dev_namespaced:
            config_file: orgs/dev.json
            days: 7
            namespaced: True
        prerelease:
            config_file: orgs/prerelease.json
            days: 7
        npsp:
            config_file: orgs/npsp.json
            days: 7
        npsp_namespaced:
            config_file: orgs/npsp.json
            days: 7
            namespaced: True

tasks:
    robot:
        options:
            suites: robot/pmdm/tests
            options:
                outputdir: robot/pmdm/results

    robot_testdoc:
        options:
            path: robot/pmdm/tests
            output: robot/pmdm/doc/pmdm_tests.html

    run_all_local_tests:
        group: 'Tests'
        description: 'Runs all local Apex Tests including code coverage'
        class_path: cumulusci.tasks.sfdx.SFDXOrgTask
        options:
            command: 'force:apex:test:run --codecoverage --testlevel RunLocalTests --resultformat human'

    dx:
        group: 'Salesforce DX'
        description: 'Calls a sfdx task with the cci Org User specificed.  Enter the sfdx task with the command option'
        class_path: cumulusci.tasks.sfdx.SFDXOrgTask

    dx_status:
        group: 'Salesforce DX'
        description: 'Calls sfdx force:source:status for cci Org User'
        class_path: cumulusci.tasks.sfdx.SFDXOrgTask
        options:
            command: 'force:source:status'

    add_caseman_dependency:
        group: Impact Engineering
        description: Installs CaseMan with dependencies
        class_path: cumulusci.tasks.salesforce.UpdateDependencies
        options:
            dependencies:
                - github: "https://github.com/SalesforceFoundation/caseman"
            include_beta: True

    log_bulk_data_mapping:
        group: "Data: Bulk"
        description: "Generates a combined mapping configuration for cumulusci.tasks.bulkdata"
        class_path: tasks.BulkData.LogMapping
        options:
            package_mapping_directories:
                - data/bulk/mapping/caseman
                - data/bulk/mapping/npsp
                - data/bulk/mapping/pmdm
            pre_mapping_configs:
                - path: data/bulk/mapping/Household_Accounts.yml
                - path: data/bulk/mapping/Organization_Accounts.yml
                - path: data/bulk/mapping/Contacts.yml

    capture_bulk_data:
        group: "Data: Bulk"
        description: "Captures a snapshot of org's bulk data to sql_path.  Only uses in an org with all possible packages installed."
        class_path: tasks.BulkData.CaptureData
        options:
            sql_path: data/bulk/data.sql
            ignore_row_errors: True
            package_mapping_directories:
                - data/bulk/mapping/caseman
                - data/bulk/mapping/npsp
                - data/bulk/mapping/pmdm
            pre_mapping_configs:
                - path: data/bulk/mapping/Household_Accounts.yml
                - path: data/bulk/mapping/Organization_Accounts.yml
                - path: data/bulk/mapping/Contacts.yml
            log_mapping: True

    insert_bulk_data:
        group: "Data: Bulk"
        description: "Inserts bulk data at sql_path into org with auto-generated mapping"
        class_path: tasks.BulkData.InsertData
        options:
            sql_path: data/bulk/data.sql
            ignore_row_errors: True
            package_mapping_directories:
                - data/bulk/mapping/caseman
                - data/bulk/mapping/npsp
                - data/bulk/mapping/pmdm
            pre_mapping_configs:
                - path: data/bulk/mapping/Household_Accounts.yml
                - path: data/bulk/mapping/Organization_Accounts.yml
                - path: data/bulk/mapping/Contacts.yml
            log_mapping: True

    upload_client_photos:
        group: "Data: Bulk: CaseMan"
        description: "Upload client photos and link to client records"
        class_path: "tasks.UploadClientPhotos.UploadClientPhotos"
        options:
            directory_path: "data/bulk/client-photos"

flows:
    
    caseman_org:
        steps:
            100:
                task: add_caseman_dependency
            200:
                flow: dev_org
            300:
                task: upload_client_photos

    caseman_org_namspaced:
        steps:
            100:
                task: add_caseman_dependency
            200:
                flow: dev_org_namespaced
            300:
                task: upload_client_photos

    config_unmanaged:
        steps:
            200:
                task: insert_bulk_data
            301:
                task: execute_anon
                options:
                    path: "data/scripts/update_all_records_as_recently_viewed.apex"

    config_unmanaged_namespaced:
        steps:
            200:
                task: insert_bulk_data
            301:
                task: execute_anon
                options:
                    path: "data/scripts/update_all_records_as_recently_viewed.apex"

    config_qa:
        100:
            task: deploy_qa_config
        200:
            flow: config_unmanaged

    config_dev:
        steps:
            200:
                flow: config_unmanaged

    config_dev_namespaced:
        steps:
            200:
                flow: config_unmanaged_namespaced

    dev_org_namespaced:
        steps:
            1:
                flow: dependencies
            2:
                flow: deploy_unmanaged
            3:
                flow: config_dev_namespaced
            4:
                task: snapshot_changes

